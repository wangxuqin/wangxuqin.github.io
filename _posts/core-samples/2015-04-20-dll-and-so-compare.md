---
layout: post
title:  "Window动态库与Linux共享对象比较（转）"
date:   2015-04-20 10:00
categories: Common
---
原文：http://wenku.baidu.com/view/693ad13610661ed9ad51f310.html?re=view
###摘要
动态链接库技术实现和涉及程序常用的技术，在Windows和Linux系统中都有动态库的概念，采用动态库可以有效的减少程序大小，节省空间，提交效率，增加程序的可扩展性，便于模块化管理。但不同操作系统的动态库由于格式不同，在需要不同操作系统调用时需要进行动态库程序移植。本文分析和比较了两种操作系统动态库技术。 

 
###1.引言
动态库(Dynamic Link Library abbr, DLL)技术是程序设计中经常采用的技术。其目的减少程序的大小，节省空间，提高效率，具有很高的灵活性。采用动态库技术对于升级软件版本更加容易。与静态库(Static Link Library)不同，动态库里面的函数不是执行程序本身的一部分，而是根据执行需要按需载入，其执行代码可以同时在多个程序中共享。  

在Windows和Linux系统中，都可以采用这种方式进行软件设计，但它们的调用方式以及程序编制方式不尽相同。本文首先首先分析了在这种两种操作系统中通常采用的动态库调用方式以及程序编制方式，最后分析比较了这两种方式的不同之处。

###2.动态库技术
####2.1 Windows动态库技术####
动态链接库是实现Windows应用程序共享资源、节省内存空间、提高使用效率的一个重要技术手段。常见的动态库包含外部函数和资源，也有一些动态库只包含资源，如Windows字体资源文件，称之为资源动态库链接库。通常动态库以**.dll 、.drv 、 .fon**等作为后缀。相应的Windows静态库通常以.lib结尾，Windows自己将一些主要的系统功能以动态库模块的形式实现。 Windows动态库在运行时被系统加载到进程的虚拟空间中，使用从调用进程的虚拟空间分配的内存，成为调用进程的一部分。特点:  
1. DLL也只能被该进程的线程所访问;  
2. DLL的句柄可以被调用进程使用;  
3. 调用进程的句柄可以被DLL使用;  
4. DLL模块中包含各种导出函数，用于向外界提供服务;  
5. DLL可以有自己的数据段，但没有自己的堆栈，使用与调用它的应用程序相同的堆栈模式;  
6. 一个DLL在内存中至有一个实例;  
7. DLL实现了代码封装性;  
8. **DLL的编制与具体的额变成语言及编译器无关，可以通过DLL来实现混合语言编程**;  
9. DLL函数中的代码所创建的任何对象（包括变量）都归调用它的线程或进程所有。  

根据调用方式的不同，对动态库的调用可分为**静态调用方式**和**动态调用方式**。  
(1)静态调用，也称为隐式调用，由**编译系统完成对DLL的加载和应用程序结束时DLL卸载的编码**(Windows系统负责对DLL调用次数的计数)，调用方式简单，能否满足通常的要求。通常采用的调用方式是把产生动态链接库时产生的.LIB文件加入到应用程序的工程中，想要使用DLL中的函数，只须在源文件声明一下。**LIB文件包含了每一个DLL导出函数的符号名和可选择的标识号以及DLL文件名，不含有实际的代码加载在到内存中。  

(2)动态调用，即显示调用方式，是由编程者用API函数加载和卸载DLL来达到调用DLL的目的，比较复杂，但能够有效地使用内存，是编制大型应用程序时的重要方式。  
在Windows系统中，与动态库有关的函数包括：

```
①LoadLibrary(或MFC的AfxLoadLibrary)，装载动态库。   
②GetProcAddress获取要引入的函数，将符号名或标识号转换为DLL内部地址。   
③FreeLibrary(或MFC的AfxFreeLibrary)，释放动态库链接库。   
```

在Windows中创建动态库也非常方便和简单。在Visual C++中，可以创建不用MFC而直接用C语言写的DLL程序，也可以创建基于MFC类库的DLL程序。每一个DLL必须有一个入口点，在VC++中，DllMain是一个缺省的入口函数。DllMain负责初始化(Initalization)和结束(Termination)工作。动态库输出函数也有两种约定，分别是基于调用约定和名字修饰约定。DLL程序定义的函数分为内部函数和导出函数，动态库导出的函数供其他程序模块调用。  
通常可以有下面集中方法导出函数：   

```
①采用模块定义文件的EXPORT部分指定要输入的函数或者变量。   
②使用MFC提供的修饰符号_declspec(dllexport)。   
③以命令行方式，采用/EXPORT命令行输出有关函数。   
```

在windows动态库中，有时需要编写模块定义文件(.DEF)，它是用于描述DLL属性的模块语句组成的文本文件。

####2.2 Linux共享对象技术####
在Linux操作系统中，采用了很多共享对象技术(SharedObject)，虽然它和Windows里的动态库相对应，但它并不称为动态库。相应的共享对象文件以.so作为后缀，为了方便，在本文中，对该概念不进行专门区分。Linux系统的/lib以及标准图形界面的/usr/X11R6/lib等目录里面，就有许多以so结尾的共享对象。同样，**在Linux下，也有静态函数库这种调用方式，相应的后缀以.a结束**。Linux采用该共享对象以方便程序间共享，节省程序占有空间，增加程序的可扩展性和灵活性。Linux还可以通过LD_PRELOAD变量让开发人员可以使用自己的程序库中的模块来替换系统模块。

同Windows系统一样，在Linux中创建和使用动态库是比较容易的事情，在编译函数库源程序时加上-shared选项即可，遮掩所生成的执行程序就是动态库链接库。通常这样的以so为后缀，在Linux动态库程序设计过程中，通常流程是编写用户的接口文件，通常是.h文件，编写实际的函数文件，以.c或.cpp为后缀，再编写makefile文件。对于较小的动态库可以不用如此，但这样设计使程序更加合理。

编译生成动态链接库后，进而可以在程序中进行调用。在Linux中，可以采用多种调用方式，同WIndows的系统目录(..\system32等)一样，可以将动态库文件拷贝到/lib目录或者在lib目录里面建立符号连接，以便所有用户使用。下面介绍Linux调用动态库经常使用的函数，但在使用动态库时，源程序必须包含dlfcn.h头文件，该文件定义调用动态库链接库的函数的原型。

```
(1)打开动态链接库: dlopen，函数运行void *dlopen(const char *filename, int flag);
dlopen用于打开指定名字(filename)的动态链接库，并返回操作句柄。

(2)取函数执行地址: dlsym，函数原型为: void *dlsym(void *handle, char *symbol);
dlsyn根据动态链接库操作句柄(handle)与符号(symbol)，返回符号对应的函数的执行代码地址。

(3)关闭动态链接库：dlclose，函数原型为: int dlclose(void *handle);
dlclose用于关闭指定句柄的动态链接库，只有当此动态链接库的使用计数为0时，才会真正被系统卸载。

(4)动态库错误函数: dlerror，函数原型为: const char* dlerror(void);
当动态链接库操作函数执行失败时，dlerror可以返回出错信息，返回值为NULL时表示操作函数执行成功。
```

在取到函数执行地址后，就可以在动态库的使用程序里面根据动态库提供的函数接口声明调用动态库里面的函数。在编写调用动态库的程序的makefile文件时，需要加入编译选项-rdynamic和-ldl。


除了采用这种方式编写和调用动态库之外，Linux操作系统也提供了一种更加方便的动态库调用方式，也方便了其他程序调用，这种方式与Windows系统的链式链接类似。其动态库命名方式为lib*.so.*。在这个命令方式中，第一个*表示动态库链接库的库名，第二个*通常表示该动态库的版本好，也可以没有版本号。在这种调用方式中，需要维护动态链接库的配置文件/etc/ld.so.conf来让动态链接库为系统所使用，通常将动态链接库所在目录名追加到动态链接库配置文件中。如具有X window窗口系统发行版该文件中都具有/usr/X11R6/lib ,它指向X window窗口系统的动态链接库所在目录。为了使动态链接库能为系统所共享，还需运行动态链接库的管理命令./sbin/ldconfig。在编译所引用的动态库时，可以在gcc采用 -l 或 -L选项或直接引用所需的动态链接库方式进行编译。在Linux里面，可以采用ldd命令来检查程序依赖共享库。

###3.两种系统动态库比较分析
Windows和Linux采用动态链接库技术目的是基本一致的，但由于操作系统的不同，他们在许多方面还是不尽相同，下面从以下几个方面进行阐述。

```
(1)动态库程序编写，在Windows系统下的执行文件格式是PE格式，动态库需要一个DllMain函数作为初始化的入口，通常在导出函数的声明时需要有_declspec(dllexport)关键字。Linux下的gcc编译的执行文件默认是ELF格式，不需要初始化入口，也不需要到函数做特别声明，编写比较方便。

(2)动态库编译，在Windows系统下面，有方便的调试编译环境，通常不用自己去编写makefile文件，但在linux下面，需要自己动手去编写makefile文件，因此，必须掌握一定的makefaile编写技巧，另外，通常Linux编译规则相对严格。

(3)动态库调用方面，Windows和Linux对其下编制的动态库都可以采用显式调用或隐式调用，但具体的调用方式也不尽相同。

(4)动态库输出函数查看，在Windows中，有许多工具和软件可以进行查看DLL中输出的函数，例如命令行方式的dumpbin以及VC++工具中的DEPENDS程序。在Linux系统中通常采用nm来查看函数，也可以使用ldd查看程序隐式链接的共享对象文件。

(5)对操作系统的依赖，这两种动态运行依赖于各自的操作系统，不能跨平台使用。因此，对于实现相同功能的动态库，必须为两种不同的操作系统提供不同的动态库版本。
```

